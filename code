import time
import pyautogui
import pytesseract
import pygetwindow as gw
import gc
import requests
import sys
START_TIME = time.time()
MAX_RUNTIME = 1.5 * 60 * 60  # 1.5 —á–∞—Å–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö

def check_runtime():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω–æ –ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã"""
    elapsed = time.time() - START_TIME
    return elapsed >= MAX_RUNTIME
windows = gw.getWindowsWithTitle("STALCRAFT")
weq = gw.getWindowsWithTitle('PyCharmMiscProject ‚Äì test.py')
pytesseract.pytesseract.tesseract_cmd = r'C:\Program Files\Tesseract-OCR\tesseract.exe'


def similarity_score(str1, str2):
    """–í—ã—á–∏—Å–ª—è–µ—Ç —Å—Ö–æ–∂–µ—Å—Ç—å –¥–≤—É—Ö —Å—Ç—Ä–æ–∫ (0-1)"""
    if not str1 or not str2:
        return 0

    str1, str2 = str1.lower(), str2.lower()

    # –ü—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç —Å—Ö–æ–∂–µ—Å—Ç–∏
    matches = sum(1 for a, b in zip(str1, str2) if a == b)
    max_len = max(len(str1), len(str2))

    return matches / max_len if max_len > 0 else 0

def click_at(x, y):
    try:
        pyautogui.moveTo(x, y)
        pyautogui.click()
        time.sleep(0.1)
    except Exception as e:
        return e


def capture_and_recognize1(x1, y1, x2, y2):
    try:
        screenshot1 = pyautogui.screenshot(region=(x1, y1, x2 - x1, y2 - y1))
        config = '--psm 6 -c tessedit_char_blacklist=¬©¬Æ‚Ñ¢¬ß-¬©!?/.,_-=+*&^%$#@!'
        text1 = pytesseract.image_to_string(screenshot1, lang='rus', config=config).lower()
        del screenshot1
        return [line for line in text1.splitlines()
                if line.strip() and '–æ—Å—Ç–∞–ª–æ—Å—å' not in line and '–æ—Å—Ç–µ–ª–æ—Å—å' not in line]
    except Exception as e:
        return e


def capture_and_recognize_price(x1, y1, x2, y2):
    """–§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ü–µ–Ω—ã"""
    try:
        screenshot = pyautogui.screenshot(region=(x1, y1, x2 - x1, y2 - y1))
        config = '--psm 6 -c tessedit_char_whitelist=0123456789'
        text = pytesseract.image_to_string(screenshot, lang='rus', config=config)
        del screenshot

        # –û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ - –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
        cleaned_text = ''.join(filter(str.isdigit, text))
        return cleaned_text
    except Exception as e:
        return str(e)


webhook_url = "–≤–∞—à –≤–µ–± —Ö—É–∫"
discord_avatar_url = "—Å—Å—ã–ª–∫–∞ url –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É"
bot_name = '–Ω–∞–∑–≤–∞–Ω–∏–µ –±–æ—Ç–∞'


def discord_push(message):
    data = {
        "content": message,
        "username": bot_name,
        "avatar_url": discord_avatar_url
    }
    try:
        response = requests.post(
            webhook_url,
            json=data,
            timeout=5
        )
        if response.status_code == 204:
            return True
        else:
            return False
    except Exception as e:
        return e


def clean_text(text, is_price=False):
    if not text:
        return text

    chars_to_remove = ' "\'.:()¬´¬ª<>/\\¬©|' if not is_price else ' —Ä—É–±–ª—å—Ä—É–±–ª—è—Ä—É–±–ª–µ–π:'
    translator = str.maketrans('', '', chars_to_remove)
    return text.translate(translator)


def buy_item(slot_number, item_name, item_price):
    buy_coordinates = [(1295, 408), (1295, 448), (1295, 483), (1295, 520), (1295, 557),
                       (1295, 595), (1295, 634), (1295, 669), (1326, 706)]
    buy_coordinates2 = [(1326, 446), (1326, 486), (1326, 522), (1326, 556), (1326, 590),
                        (1326, 635), (1326, 668), (1326, 709), (1326, 741)]
    price_coordinates = [
        (1250, 390, 1384, 426),  # 0
        (1250, 430, 1384, 466),  # 1
        (1250, 467, 1384, 502),  # 2
        (1250, 504, 1384, 539),  # 3
        (1250, 541, 1384, 575),  # 4
        (1250, 578, 1384, 611),  # 5
        (1250, 615, 1384, 653),  # 6
        (1250, 652, 1384, 687),  # 7
        (1250, 689, 1384, 724), ]  # 8
    names_coordinates = [
        (925, 390, 1130, 408),  # 0
        (925, 430, 1130, 446),  # 1
        (925, 467, 1130, 482),  # 2
        (925, 504, 1130, 519),  # 3
        (925, 540, 1130, 557),  # 4
        (925, 578, 1130, 593),  # 5
        (925, 614, 1130, 631),  # 6
        (925, 651, 1130, 668),  # 7
        (925, 690, 1130, 705), ]  # 8

    x1, y1, x2, y2 = price_coordinates[slot_number]
    recognized_price = capture_and_recognize_price(x1, y1, x2, y2)

    x1, y1, x2, y2 = names_coordinates[slot_number]
    recognized_name_list = capture_and_recognize1(x1, y1, x2, y2)
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–ø–∏—Å–æ–∫ –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    recognized_name = clean_text(recognized_name_list[0]) if recognized_name_list else ""

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–µ–Ω—É (–¥–æ–ª–∂–Ω–∞ —Ç–æ—á–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å)
    price_matches = (recognized_price and recognized_price == item_price.replace(' ', ''))

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Å –¥–æ–ø—É—Å–∫–æ–º –Ω–∞ –æ—à–∏–±–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
    similarity = similarity_score(recognized_name, item_name)
    name_matches = similarity > 0.85  # 70% —Å—Ö–æ–∂–µ—Å—Ç–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ

    if price_matches and name_matches:
        buy_x, buy_y = buy_coordinates[slot_number]
        buy_x2, buy_y2 = buy_coordinates2[slot_number]
        click_at(buy_x, buy_y)
        click_at(buy_x2, buy_y2)
        time.sleep(1)
        click_at(961, 585)
        return item_name, recognized_price, item_price
    else:
        return None, None, None


prices = { #—á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∏ –∑–∞–Ω–µ—Å—Ç–∏ –≤ –±–∞–∑—É, –≤ 190 —Å—Ç—Ä–æ–∫–µ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã –æ—á–∏—â–µ–Ω–Ω–∏—è —Å—Ç—Ä–æ–∫ —Å –ø–æ–º–æ—â—å—é print('full_clean1'), –ø–æ—Å–ª–µ —á–µ–≥–æ –∑–∞–Ω–µ—Å–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –±–∞–∑—É –ø–æ —Ç–∏–ø—É: (–Ω–∞–∑–≤–∞–Ω–∏–µ: —Ü–µ–Ω–∞)
    '–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ–∑–∞–ø—á–∞—Å—Ç–∏': 36500, '–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã': 39000,
    '—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ–∑–∞–ø—á–∞—Å—Ç–∏': 14500, '–∑–∞–≥–∞–¥–æ—á–Ω–∞—è–¥–æ–±—ã—á–∞': 40000, '—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã': 14500,
    '–¥–µ—à–µ–≤—ã–µ–∑–∞–ø—á–∞—Å—Ç–∏': 8000, '–ø–æ—Ä—Ç–∞—Ç–∏–≤–Ω—ã–π–∫–≤–∞–Ω—Ç–æ–≤—ã–π–≥–µ–Ω–µ—Ä–∞': 42000, '–º—É–ª—å—Ç–∏—Ç—É–ª': 4000,
    '—Å—ã–≤–æ—Ä–æ—Ç–∫–∞–∏–∑–º–µ–Ω–µ–Ω–∏—è': 110000, '–æ—á–∏—â–µ–Ω–Ω–æ–µ–≤–µ—â–µ—Å—Ç–≤–æ07270': 12000,
    '–ø—Å–∏–º–∞—è—á–æ–∫': 12000, '–Ω–∞–±–æ—Ä–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤–æ—Ä—É–∂–∏—è–º–∞': 31000, '–Ω–∞–±–æ—Ä–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤–æ—Ä—É–∂–∏—è–≤–µ': 31000,
    '—Å–ø–∏—Ä–∞–ª—å': 22000, '–∞—Ä–º–µ–π—Å–∫–∏–π–∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä': 15000, '—Å—Ç–∞—Ä—ã–π—Å–∫–∞—Ä–±': 30000, '–±–æ–µ–≤–æ–π–Ω–∞–±–æ—Ä': 170000,
    '–∫–∞—Ç–∞–ª–∏–∑–∞—Ç–æ—Ä': 4000, '–ø—Ä–æ—Ç–æ–∞—Ä—Ç–µ—Ñ–∞–∫—Ç': 2897,
    '–±–∞—Ä–∞–±–∞–Ω–Ω—ã–π–º–∞–≥–∞–∑–∏–Ω545': 1750000, '—è–Ω—Ç–∞—Ä–Ω–∞—è–ø–æ–ª—ã–Ω—å': 10111, '–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∫–µ–≥–∞': 150001,
    '–Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞—è–∞–Ω–æ–º–∞–ª—å–Ω–∞—è–±–∞—Ç–∞': 38000, '—Ü–≤–µ—Ç—É—â–∏–π—Å–µ–≤–µ—Ä–Ω—ã–π–º–æ—Ö': 18000,
    '–∞–º–º–∏–∞–∫': 11111, '–±–ª–æ–∫–¥–∞–Ω–Ω—ã—Ö–≥–∞–º–º–∞': 35000, '—Ç–∞–∫—Ç–∏—á–µ—Å–∫–∏–π–∑–∞–ø–∞—Å': 64000, '–∫–∞–º–µ–Ω—å–∂–º—ã—Ö–≤–∂—É—Ö–ø–ª—é—Ö': 40000,
    '—Ç–µ–º–Ω—ã–π–ª–∏–º–±': 115000, '—Ä–∞—Å—Ü–≤–µ—Ç—à–∏–π–≥–æ—Ä—å–∫–æ–ª–∏—Å—Ç–Ω–∏–∫': 70000, '—ç—Å—Å–µ–Ω—Ü–∏—è—Å–±—Ä–æ—Å–∞': 3250001,
    '–¥–∞—Ä—à–µ–ø–æ—Ç–∞': 55000, '–∞–∫308': 11000000, '–¥–µ—Ç–µ–∫—Ç–æ—Ä—É–∑–∫–æ–≥–æ–¥–∏–∞–ø–∞–∑–æ–Ω–∞—ç–ª': 20000000, '–∞–ª—é–º–∏–Ω–∏–µ–≤–∞—è–±–∏—Ç–∞': 45000,
    '–æ—Ü14–º—É—Ä–∞–≥–∞–Ω': 250000, '–º249–±–∞—É': 500000, '–æ—Ç–µ—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π—Å–∞–º–æ–¥–µ–ª—å–Ω—ã–π–∫–æ': 230000, '—Å–∞–º–æ–¥–µ–ª—å–Ω—ã–π–ª—Ü—É': 320000, '–¥—Ç–∫–≤–∏—Ö—Ä—å': 150000,
    '–∑–∞–¥–∞–∫–æ—Ç—Ç–∞–ø–¥–æ': 650000, '–∑–≥–¥—á–∫–æ—Ç—Ç–∞–ø–∞–æ': 700000, '–∑–∞–æ—á–∫–æ—Ç—Ç–∞–ø–∞–æ': 700000, '—Å–≤–ø–µ—É–≥–∞—Å–º–∑–æ–æ': 7000000, '—Å–∞–º–æ–¥–µ–ª—å–Ω–∞—è—Å–∫–æ—à–µ–Ω–Ω–∞—è—Ä—É–∫–æ—è—Ç': 600000,
    '—Å–ø–µ—É–π–∞—Å–º–∑–æ–æ': 7500000, '—Ü62': 150000, '–æ–µ–≥—É–∞–º–∫12–∞': 4500000, '—ç—Ä–≥–æ–Ω–æ–º–∏—á–Ω—ã–π–º–∞–≥–∞–∑–∏–Ω762—Ö39': 500000, '–ø—Ä–∏—Ü–µ–ª–∫–æ–ª–ª–∏–º–∞—Ç–æ—Ä–Ω—ã–π–ø–∫–æ1—Ç': 120000,
    '–æ–µ–≥—É–∞–º–∫12–∞51035': 5000000, '–º48—Ç–æ—Ç–∞–∞–∏–∫': 150000, '–º–∞8—Ç–æ—Ç–∞–π–∞–º': 150000, '–º48—Ç–æ—Ç–∞–π–∞–º–∫': 125000,
    '–º–∞8—Ç–æ—Ç–∞–π–∞–º–∫': 150000,
    '–ø—Ä–µ–º–∏—É–º–Ω–∞1–¥–µ–Ω—å': 1000000, '–ø—Ä–µ–º–∏—É–º–Ω–∞30–¥–Ω–µ–π': 2400000, '–ø—Ä–µ–º–∏—É–º–Ω–∞180–¥–Ω–µ–π': 9000000,
    '–±—Ä–æ–Ω–µ—Å–∫–µ–ª–µ—Ç–∞–ª—å–±–∞—Ç—Ä–æ—Å–ø–µ—Ä–µ—Ö': 13000000, '—ç–∫–∑–æ–±—Ä–æ–Ω—è–∞–ª—å–±–∞—Ç—Ä–æ—Å—Ä–∞–∑–≤–µ–¥—á': 3550000, '—ç–∫–∑–æ–±—Ä–æ–Ω—è–∞–ª—å–±–∞—Ç—Ä–æ—Å–ª–∞–∑—É—Ç—á–∏': 855000,
    '–±—Ä–æ–Ω–µ–∫–æ—Å—Ç—é–º–∫–∑4': 6000001, '–æ—Å—Ç–∞—Ç–∫–∏–ø—Ä–∏–±–æ—Ä–æ–≤—à–µ–ø–æ—Ç–∞': 58000, '–±–ª–æ–∫–¥–∞–Ω–Ω—ã—Ö–ª—è–º–±–¥–∞': 40000, '–∫–ª—é—á–æ—Ç–Ω–∞—É—á–Ω–æ–≥–æ—Å–µ–π—Ñ–∞': 190000,
    '—É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π–º–∞–≥–∞–∑–∏–Ω–∞–∫308': 200000, '—Ñ–∏–ª—å—Ç—Ä': 3500, '–¥–æ—Ä–æ–≥–∏–µ—Å–∏–≥–∞—Ä–µ—Ç—ã': 2500, '–∫–æ–º–±–∏–Ω–µ–∑–æ–Ω–º–∞–≥–Ω–∏—Ç': 110000, '–Ω–∫–∞17': 2800000, '–Ω–∫–º—Ä7–∞2': 17000000
}

def main():
    result = []
    time.sleep(0.05)
    click_at(1333, 347)
    time.sleep(0.05)
    result1 = capture_and_recognize1(925, 390, 1130, 724)
    result2 = capture_and_recognize1(1247, 390, 1383, 724)
    time.sleep(0.35)
    full_clean1 = [clean_text(item) for item in result1 if item.strip()]
    full_clean2 = [clean_text(item, is_price=True) for item in result2 if item.strip()]
    del result1, result2
    if len(full_clean1) == len(full_clean2) == 9:
        for i, (item, price_str) in enumerate(zip(full_clean1, full_clean2)):
            try:
                price_clean = price_str.replace(' ', '')
                price = int(price_clean)
                if item in prices and price <= prices[item]:
                    result.append(i)
            except ValueError:
                continue
    if result:
        item_index = result[0]
        item_name = full_clean1[item_index]
        item_price = full_clean2[item_index].replace(' ', '')
        bought_item, confirmation_text, buy_price = buy_item(item_index, item_name, item_price)
        if bought_item:
            message = f"üéâ{bought_item}\n–¶–µ–Ω–∞: {buy_price} —Ä—É–±.\n–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: {confirmation_text}\n-------------------"
        else:
            message = f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ: {item_name}"
        discord_push(message)

if windows:
    windows[0].activate()
    time.sleep(0.4)

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
i = 0
while True:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç—ã
    if check_runtime():
        print("–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –∏—Å—Ç–µ–∫–ª–æ (1.5 —á–∞—Å–∞). –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã.")
        break
    main()
    # –û—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏ –∫–∞–∂–¥—ã–µ 10 —Ü–∏–∫–ª–æ–≤
    i += 1
    if i % 15 == 0:
        n = capture_and_recognize1(1250, 806, 1342, 824)
        time.sleep(0.2)
        n[0] = n[0].replace(':', '').replace('—Ç', '')
        balance = int(n[0].replace(' ', ''))
        del n
        if balance <= 300000:
            message = "–∑–∞–≤–µ—Ä—à–∞—é —Ä–∞–±–æ—Ç—É, –±–∞–ª–∞–Ω—Å <300k"
            discord_push(message)
            time.sleep(1)
            sys.exit(0)
        del balance
        gc.collect()
        elapsed = time.time() - START_TIME
        remaining = MAX_RUNTIME - elapsed
        hours = int(remaining // 9000)
        minutes = int((remaining % 3600) // 60)
